<Html>
<Head>
  <Style>
    table { border: 1px solid red; width: 80%; align: center; }
    tr { border: 1px solid green; }
    th { border: 1px solid blue; }
    td { border: 1px solid green; text-align: center; }
  </Style>
</Head>
<Body BGColor="White">


<P>
An average home in Montclair assessed at <span id="avgHomeValue"></span>
will see a tax increase of 
$258
in 
2023 
and an average tax increase of
$732 by
2027
</P>

<P>
My home is assessed at 
<Input Type="number" id="myHomeValue" value="0">
<button id="dowork">Compute</button>
</P>
<P>
I will see addition tax for each year of:
<Table id="annualCosts">
</Table>
</P>
<P>
This is based upon expected bond sales:
<Table id="bondSales">
</Table>

<P><canvas id="paymentChart"></canvas></P>

<script>
  // This is the code which may be changed to "fit" with the HTML
  document.addEventListener("DOMContentLoaded", () => populateInitialValues("avgHomeValue", "myHomeValue", 
								            "annualCosts", "bondSales", 
                                                                            "paymentChart"));

  let dowork = document.getElementById("dowork");
  dowork.onclick = function() 
  {
    displayAnnualCosts("myHomeValue", "annualCosts"); // Display table of values
    buildChartData("myHomeValue", "paymentChart"); // Build graphical chart
  }
</script>

<script>
  // These are values which aren't code, but which are subject to 
  // change.

  const avgHomeValue = 628952; // Average house value
  const coffeeCost = 1.50; // Cost of a cup of coffee

  // Table of payments based upon expected bond sales
  let tranches = [ 
	{firstYear: 2022, years: 20, amount: 100, label: "first tranche", color: "rgba(255,0,0,0.5)"}, 
	{firstYear: 2024, years: 20, amount: 300, label: "second tranche", color: "rgba(0,255,0,0.5)"},
	{firstYear: 2026, years: 20, amount: 500, label: "third tranche", color: "rgba(0,0,255,0.5)"}, 
	];


</script>


<script>
  // This is mostly HTML-free, with the exception of the header of the table.
  // I left that in here because that is coupled with the content of the table.
  // That is: change the table's columns and the header must also be changed.  


  const moneyFormat = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
  const coffeeFormat = new Intl.NumberFormat('en-US', { maximumSignificantDigits: 3 });
  let annualCost = new Map();

  // From the tranches, determine each year's costs
  function buildCostTable()
  {

    // Add a given amount to what is to be paid each year.
    function addToCost(year, amount)
    {
      if (annualCost.has(year))
      {
        annualCost.set(year, annualCost.get(year) + amount)
      }
      else
      {
        annualCost.set(year, amount)
      }
    }

    // Look over each tranche, adding the amount owed for a given year to 
    // that year's total.
    for (const tranche of tranches)
    {
      for (let year = tranche.firstYear; year < (tranche.firstYear + tranche.years); year++)
      {
        addToCost(year, tranche.amount);
      }
    }
  }

  // Display a table of bond repayments
  function displayAnnualCosts(homeValueElementName, targetElementName)
  {
    let table = document.getElementById(targetElementName);
    const myHomeValue = document.getElementById(homeValueElementName).value; // Is this a number?
    const ratio = myHomeValue / avgHomeValue; // Is this a number?

    table.innerHTML = "<TR><TH>Year<TH>Amount<TH>Daily Amount<TH>Cups of Coffee</TR>"; // Header for table

    for (const [year, amount] of annualCost)
    {
        // Should test the product of amount and ratio for isNaN()
	annualAmount = amount * ratio;
	dailyAmount = annualAmount / 365;
	coffeeAmount = dailyAmount / coffeeCost;
	table.innerHTML += "<TR><TD>" + year.toString() + 
		"<TD>" + moneyFormat.format(annualAmount) + 
		"<TD>" + moneyFormat.format(dailyAmount) + 
		"<TD>" + coffeeFormat.format(coffeeAmount) + 
		"<\TR>";
    }
  }


  // Display the table of expected bond sales
  function displayTranches(targetElementName)
  {
    let table = document.getElementById(targetElementName);
    table.innerHTML = "<TH><TH>Year of Sale<TH>Duration of Bonds<TH>Annual Increase for Repayment";
    for (const tranche of tranches)
    {
      table.innerHTML += "<TR style=\"color: " + tranche.color + ";\">" +
                "<TD>" + tranche.label +
                "<TD>" + tranche.firstYear.toString() +
		"<TD>" + tranche.years.toString() +
		"<TD>" + moneyFormat.format(tranche.amount) +
		"</TR>";
    }  
}


  // Set up initial values: Average home value, payment tables, etc.
  function populateInitialValues(avgHomeValueElementName, homeValueElementName, targetElementName, 
                                 bondSalesElementName, chartDisplayElementName)
  {
    buildCostTable(); // From the tranche sales, determine annual payments for average home

    // Put average home price on the page
    let avgHomeValueElement = document.getElementById(avgHomeValueElementName);
    avgHomeValueElement.innerHTML = moneyFormat.format(avgHomeValue);

    // Set the initial value of "my home value" to the average home price
    let myHomeValueElement = document.getElementById(homeValueElementName);
    myHomeValueElement.value = avgHomeValue;

    // Display initial payment table
    displayAnnualCosts(homeValueElementName, targetElementName);

    // Display expected bond sales
    displayTranches(bondSalesElementName);

    // Build initial graphical chart
    buildChartData(homeValueElementName, chartDisplayElementName);
  }


  function formatYLabels(val, index, ticks) // Control appearance of amounts on Y axis of graphical chart
  {
     return(moneyFormat.format(val));
  }

  // Static configuration of graphical chart
  const chartConfig = 
  {
    type: 'bar',
    options: { scales: 
               { 
                 x: { stacked: true }, 
                 y: { stacked: true, ticks: { callback: formatYLabels } }
               }
             }
  };


  // Build the dynamic data for the graphical chart and (re)display that chart
  function buildChartData(homeValueElementName, chartDisplayElementName)
  {
    let chartData = new Map();
    const myHomeValue = document.getElementById(homeValueElementName).value; // Is this a number?
    const ratio = myHomeValue / avgHomeValue; // Is this a number?
    let chartDatasets = [];
    for (const tranche of tranches)
    {
      let thisDataSet = new Map();
      thisDataSet.set('backgroundColor', tranche.color);
      thisDataSet.set('label', tranche.label);
      let data = new Map();
      for (let year = tranche.firstYear; year < (tranche.firstYear + tranche.years); year++)
      {
        amount = tranche.amount * ratio;
	data.set(year, amount);
      }
      thisDataSet.set('data', Object.fromEntries(data));
      chartDatasets.push(Object.fromEntries(thisDataSet));
    }
    chartData.set('datasets', chartDatasets);
    chartConfig.data = Object.fromEntries(chartData);
    if (document.getElementById(chartDisplayElementName).hasOwnProperty('chart')) // Cleanup previous canvas if exists
    {
      document.getElementById(chartDisplayElementName).chart.destroy();
    }
    // Build the chart in the canvas with the specified id
    const paymentChart = new Chart(document.getElementById(chartDisplayElementName), chartConfig); 
    document.getElementById(chartDisplayElementName).chart = paymentChart; // Store canvas for later cleanup
  }

</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
</script>


</Body>
</Html>
